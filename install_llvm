
prefix=`echo $1`
target=`echo $2`

here=`pwd .`

llvm_base=${prefix}/llvm

llvm_src=${llvm_base}/src
llvm_build=${llvm_base}/build
clang_src=${llvm_src}/tools/clang
libcxx_src=${llvm_src}/projects/libcxx
libcxxabi_src=${llvm_src}/projects/libcxxabi

version=3.6.2

echo ===== Building LLVM-${version} in base dir ${llvm_base} for target ${target}

echo === Checking files
downloads=${prefix}/downloads
test -d ${downloads} || echo dir ${downloads} does not exist
llvm_tar=llvm-${version}.src.tar.xz
test -f ${downloads}/${llvm_tar} || (echo file ${downloads}/${llvm_tar} does not exist && exit 1)
clang_tar=cfe-${version}.src.tar.xz
test -f ${downloads}/${clang_tar} || (echo file ${downloads}/${clang_tar} does not exist && exit 1)
libcxx_tar=libcxx-${version}.src.tar.xz
test -f ${downloads}/${libcxx_tar} || (echo file ${downloads}/${libcxx_tar} does not exist && exit 1)
libcxxabi_tar=libcxxabi-${version}.src.tar.xz
test -f ${downloads}/${libcxxabi_tar} || (echo file ${downloads}/${libcxxabi_tar} does not exist && exit 1)
echo ok

echo === Setup project dirs
test -d ${llvm_base} || ( 		echo Creating dir ${llvm_base} && mkdir -p ${llvm_base} 			)
test -d ${llvm_src} || (		echo Untarring llvm sources to ${llvm_src} &&
								tar xf ${downloads}/${llvm_tar} -C ${llvm_base} &&
								mv ${llvm_base}/llvm-${version}.src ${llvm_src}						)
test -d ${clang_src} || (		echo Untarring clang sources to ${clang_src} &&
								tar xf ${downloads}/${clang_tar} -C ${llvm_src}/tools &&
								mv ${llvm_src}/tools/cfe-${version}.src ${clang_src} 				)
test -d ${libcxx_src} || (		echo Untarring libcxx sources to ${libcxx_src} &&
								tar xf ${downloads}/${libcxx_tar} -C ${llvm_src}/projects &&
								mv ${llvm_src}/projects/libcxx-${version}.src ${libcxx_src}			)
test -d ${libcxxabi_src} || (	echo Untarring libcxxabi sources to ${libcxxabi_src} &&
								tar xf ${downloads}/${libcxxabi_tar} -C ${llvm_src}/projects &&
								mv ${llvm_src}/projects/libcxxabi-${version}.src ${libcxxabi_src}	)
test -d ${llvm_build} || ( 		echo Creating dir ${llvm_build} && mkdir ${llvm_build} 				)

echo === Making
cd ${llvm_build}
echo = Configure
../src/configure --prefix=${here}/${llvm_base} --enable-optimized --enable-assertions --enable-debug-symbols --enable-targets=${target}
echo = Making LLVM and Clang
make
echo = Making libc++
cmake ../src -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
make cxx
